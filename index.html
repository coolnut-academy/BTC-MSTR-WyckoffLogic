<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyckoff Logic Pro: Ultimate Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
        }
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        .card-gradient {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            box-shadow: 5px 5px 10px #0b1120, -5px -5px 10px #27354d;
        }
        .input-dark {
            background-color: #334155;
            border: 1px solid #475569;
            color: white;
            transition: all 0.3s;
        }
        .input-dark:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .gauge-container {
            position: relative;
            width: 100%;
            height: 12px;
            background: #334155;
            border-radius: 6px;
            overflow: hidden;
        }
        .gauge-fill {
            height: 100%;
            transition: width 0.5s ease-in-out, background-color 0.5s;
        }
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #475569;
            border-radius: 2px;
        }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        /* Table Styles */
        .ladder-table th {
            text-align: left;
            padding: 8px;
            font-size: 0.75rem;
            color: #94a3b8;
            border-bottom: 1px solid #334155;
        }
        .ladder-table td {
            padding: 8px;
            font-size: 0.85rem;
            border-bottom: 1px solid #1e293b;
        }
        .neon-text-green { text-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
        .neon-text-red { text-shadow: 0 0 10px rgba(248, 113, 113, 0.5); }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed; 
            z-index: 50; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.85); 
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1e293b;
            padding: 24px;
            border: 1px solid #475569;
            width: 90%; 
            max-width: 400px;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: modalPop 0.3s ease-out;
        }
        @keyframes modalPop {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Toast Styles */
        .toast {
            visibility: hidden;
            min-width: 300px;
            background-color: #1e293b;
            color: #fff;
            text-align: center;
            border-radius: 12px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            right: 20px;
            top: 20px;
            font-size: 14px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            border-left: 6px solid #333;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast.show {
            visibility: visible;
            transform: translateX(0);
        }
        .toast.success { border-left-color: #22c55e; }
        .toast.error { border-left-color: #ef4444; }
    </style>
</head>
<body class="min-h-screen p-2 md:p-4 pb-32 max-w-7xl mx-auto">

    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-400">
                <i class="fa-solid fa-layer-group mr-2"></i>Wyckoff Logic Pro
            </h1>
            <p class="text-xs text-slate-400">Ultimate Asset Allocation & Analysis Console</p>
        </div>
        
        <!-- FX Rate Display -->
        <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700 flex items-center gap-3">
            <div class="text-xs text-slate-400">
                <i class="fa-solid fa-money-bill-transfer mr-1"></i>USD/THB
            </div>
            <div class="text-lg font-mono font-bold text-yellow-400" id="fx-rate">34.50</div>
            <div class="text-[10px] text-slate-500 flex items-center">
                <span id="fx-status" class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1 blink"></span>
                <span id="fx-source">Live</span>
            </div>
        </div>
    </header>

    <!-- SECTION 1: VISUAL DASHBOARD (Charts & Score) -->
    <section class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- Bitcoin Card -->
        <div id="btc-card" class="card-gradient rounded-2xl p-5 border-l-4 border-yellow-500 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-2 opacity-10">
                <i class="fa-brands fa-bitcoin text-8xl"></i>
            </div>
            
            <div class="flex justify-between items-start mb-4 relative z-10">
                <div>
                    <h2 class="text-xl font-bold text-yellow-500">BTC / THB</h2>
                    <p class="text-xs text-slate-400">Bitkub Exchange</p>
                </div>
                <div class="text-right">
                    <div id="btc-price" class="text-2xl font-mono font-bold text-white transition-all">2,710,000</div>
                    <div id="btc-change" class="text-xs font-bold text-red-400">-1.2% (24h)</div>
                </div>
            </div>

            <!-- Wyckoff Analysis Block -->
            <div class="bg-slate-900/50 rounded-lg p-3 mb-4 backdrop-blur-sm border border-slate-700">
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-400">RSI (14)</span>
                    <span id="btc-rsi" class="font-bold text-yellow-300">35.6</span>
                </div>
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-400">Wyckoff Phase</span>
                    <span id="btc-phase" class="font-bold text-blue-300">SC (Selling Climax)</span>
                </div>
                
                <div class="mt-3">
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-slate-300">Wyckoff Buy Score</span>
                        <span id="btc-score-text" class="font-bold text-white">75/100</span>
                    </div>
                    <div class="gauge-container">
                        <div id="btc-gauge" class="gauge-fill bg-gradient-to-r from-red-500 via-yellow-500 to-green-500" style="width: 75%;"></div>
                    </div>
                    <p id="btc-recommendation" class="text-xs mt-2 text-center text-green-400 font-bold">
                        <i class="fa-solid fa-crosshairs"></i> ZONE BUY: รอเก็บไม้แรก
                    </p>
                </div>
            </div>

            <!-- Chart Area -->
            <div class="h-32 w-full">
                <canvas id="btcChart"></canvas>
            </div>
            
            <div class="mt-3 grid grid-cols-2 gap-2 text-center">
                <div class="bg-slate-800 rounded p-1">
                    <div class="text-[10px] text-slate-400">Support</div>
                    <div class="text-xs font-mono text-green-400">2,650,000</div>
                </div>
                <div class="bg-slate-800 rounded p-1">
                    <div class="text-[10px] text-slate-400">Resistance</div>
                    <div class="text-xs font-mono text-red-400">2,850,000</div>
                </div>
            </div>
        </div>

        <!-- MSTR Card -->
        <div id="mstr-card" class="card-gradient rounded-2xl p-5 border-l-4 border-red-500 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-2 opacity-10">
                <i class="fa-solid fa-building-columns text-8xl"></i>
            </div>

            <div class="flex justify-between items-start mb-4 relative z-10">
                <div>
                    <h2 class="text-xl font-bold text-red-500">MSTR</h2>
                    <p class="text-xs text-slate-400">NASDAQ (High Beta)</p>
                </div>
                <div class="text-right">
                    <div id="mstr-price" class="text-2xl font-mono font-bold text-white transition-all">$162.50</div>
                    <div id="mstr-change" class="text-xs font-bold text-red-400">-3.5% (24h)</div>
                </div>
            </div>

            <!-- Wyckoff Analysis Block -->
            <div class="bg-slate-900/50 rounded-lg p-3 mb-4 backdrop-blur-sm border border-slate-700">
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-400">RSI (14)</span>
                    <span id="mstr-rsi" class="font-bold text-red-300">30.8</span>
                </div>
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-400">Wyckoff Phase</span>
                    <span id="mstr-phase" class="font-bold text-purple-300">Potential Spring</span>
                </div>
                
                <div class="mt-3">
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-slate-300">Wyckoff Buy Score</span>
                        <span id="mstr-score-text" class="font-bold text-white">82/100</span>
                    </div>
                    <div class="gauge-container">
                        <div id="mstr-gauge" class="gauge-fill bg-gradient-to-r from-red-500 via-yellow-500 to-green-500" style="width: 82%;"></div>
                    </div>
                    <p id="mstr-recommendation" class="text-xs mt-2 text-center text-green-400 font-bold">
                        <i class="fa-solid fa-bolt"></i> AGGRESSIVE: เข้าไม้แรกเบาๆ
                    </p>
                </div>
            </div>

            <!-- Chart Area -->
            <div class="h-32 w-full">
                <canvas id="mstrChart"></canvas>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2 text-center">
                <div class="bg-slate-800 rounded p-1">
                    <div class="text-[10px] text-slate-400">Support</div>
                    <div class="text-xs font-mono text-green-400">$155.00</div>
                </div>
                <div class="bg-slate-800 rounded p-1">
                    <div class="text-[10px] text-slate-400">Resistance</div>
                    <div class="text-xs font-mono text-red-400">$180.00</div>
                </div>
            </div>
        </div>
    </section>

    <!-- SECTION 2: STRATEGY CONSOLE (Inputs & Allocation) -->
    <section class="grid md:grid-cols-12 gap-6 mb-6">
        
        <!-- Budget & Allocation -->
        <div class="md:col-span-5 bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
            <h3 class="text-sm font-bold text-white mb-4 border-b border-slate-700 pb-2">
                <i class="fa-solid fa-sliders mr-2"></i>Portfolio Configuration
            </h3>
            
            <div class="mb-5">
                <label class="block text-xs text-slate-400 mb-1">งบประมาณลงทุน (THB)</label>
                <div class="relative">
                    <span class="absolute left-3 top-2.5 text-slate-400">฿</span>
                    <input type="number" id="input-budget" value="567000" 
                        class="w-full input-dark rounded pl-8 pr-3 py-2 font-mono text-lg font-bold text-green-400 focus:text-white"
                        oninput="updateCalculations()">
                </div>
            </div>

            <div class="mb-4">
                <div class="flex justify-between text-xs mb-2">
                    <span class="text-yellow-500 font-bold"><i class="fa-brands fa-bitcoin"></i> BTC <span id="btc-pct-display">70%</span></span>
                    <span class="text-red-500 font-bold">MSTR <span id="mstr-pct-display">30%</span> <i class="fa-solid fa-building"></i></span>
                </div>
                <input type="range" id="allocation-slider" min="0" max="100" value="70" class="mb-2" oninput="updateAllocationDisplay()">
                <div class="flex justify-between text-xs font-mono text-slate-400">
                    <span id="btc-amt-display">฿396,900</span>
                    <span id="mstr-amt-display">฿170,100</span>
                </div>
            </div>
        </div>

        <!-- Strategy Selector -->
        <div class="md:col-span-7 bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
            <h3 class="text-sm font-bold text-white mb-4 border-b border-slate-700 pb-2">
                <i class="fa-solid fa-chess-knight mr-2"></i>Ladder Strategy (เลือกกลยุทธ์)
            </h3>
            
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="setStrategy('wyckoff')" id="btn-wyckoff" class="p-2 rounded border border-blue-500 bg-blue-500/20 text-blue-300 text-xs font-bold hover:bg-blue-500/30 transition">
                    Wyckoff Sniper<br><span class="font-normal text-[10px] opacity-80">40% / 60%</span>
                </button>
                <button onclick="setStrategy('dca')" id="btn-dca" class="p-2 rounded border border-slate-600 bg-slate-700 text-slate-300 text-xs hover:bg-slate-600 transition">
                    DCA Step<br><span class="font-normal text-[10px] opacity-80">33% / 33% / 33%</span>
                </button>
                <button onclick="setStrategy('pyramid')" id="btn-pyramid" class="p-2 rounded border border-slate-600 bg-slate-700 text-slate-300 text-xs hover:bg-slate-600 transition">
                    Pyramid Dip<br><span class="font-normal text-[10px] opacity-80">20% / 30% / 50%</span>
                </button>
            </div>

            <div class="bg-slate-900/50 p-3 rounded border border-slate-700 text-xs">
                <div id="strategy-desc" class="text-blue-200 mb-1 font-bold">Strategy: Wyckoff Sniper (Recommended)</div>
                <div id="strategy-detail" class="text-slate-400">เน้นจับจุด Selling Climax (SC) ไม้แรก และรอ Confirm ที่ Secondary Test (ST) ไม้ใหญ่</div>
            </div>
        </div>
    </section>

    <!-- SECTION 3: EXECUTION PLAN (Ladder Tables) -->
    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- BTC Buy Plan -->
        <div class="card-gradient rounded-xl p-4 border-l-4 border-yellow-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-yellow-500"><i class="fa-brands fa-bitcoin mr-2"></i>BTC Buy Ladder</h3>
                <div class="text-right">
                    <div class="text-[10px] text-slate-400">Target Budget</div>
                    <div class="font-mono font-bold text-white" id="btc-target-budget">฿0</div>
                </div>
            </div>
            
            <table class="w-full ladder-table">
                <thead>
                    <tr>
                        <th>Order</th>
                        <th>Condition</th>
                        <th>Price (THB)</th>
                        <th>Amount (THB)</th>
                    </tr>
                </thead>
                <tbody id="btc-ladder-body"></tbody>
            </table>
        </div>

        <!-- MSTR Buy Plan -->
        <div class="card-gradient rounded-xl p-4 border-l-4 border-red-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-red-500"><i class="fa-solid fa-building-columns mr-2"></i>MSTR Buy Ladder</h3>
                <div class="text-right">
                    <div class="text-[10px] text-slate-400">Target Budget</div>
                    <div class="font-mono font-bold text-white" id="mstr-target-budget">฿0</div>
                </div>
            </div>
            
            <table class="w-full ladder-table">
                <thead>
                    <tr>
                        <th>Order</th>
                        <th>Price ($)</th>
                        <th>Est. Cost (THB)</th>
                        <th>Shares</th>
                    </tr>
                </thead>
                <tbody id="mstr-ladder-body"></tbody>
            </table>
        </div>
    </div>

    <!-- SECTION 4: PORTFOLIO TRACKER & GOOGLE SHEETS SYNC -->
    <section class="card-gradient rounded-2xl p-6 border border-slate-700 shadow-2xl relative">
        <div class="absolute -top-3 left-6 bg-slate-900 px-3 py-1 rounded border border-blue-500 text-blue-400 text-xs font-bold uppercase tracking-wider">
            <i class="fa-solid fa-calculator mr-2"></i>Portfolio Tracker
        </div>
        <div class="absolute top-2 right-6 text-[10px] text-slate-500 flex items-center gap-1">
             <span id="fetch-status-indicator" class="w-2 h-2 rounded-full bg-slate-600"></span>
             <span id="fetch-status-text">Ready</span>
        </div>

        <div class="grid md:grid-cols-2 gap-8 mt-4">
            <!-- BTC Tracker -->
            <div class="border-b md:border-b-0 md:border-r border-slate-700 pb-6 md:pb-0 md:pr-6">
                <h4 class="text-yellow-500 font-bold mb-4 flex items-center"><i class="fa-brands fa-bitcoin mr-2"></i>Bitcoin (BTC) Status</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1">เงินลงทุนรวม (THB)</label>
                        <input type="number" id="btc-invested" placeholder="0" class="w-full input-dark rounded px-3 py-2 text-sm font-mono" oninput="calcTracker()">
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1">จำนวนเหรียญที่มี (BTC)</label>
                        <input type="number" id="btc-amount" placeholder="0.000000" step="0.000001" class="w-full input-dark rounded px-3 py-2 text-sm font-mono" oninput="calcTracker()">
                    </div>
                </div>
                <div class="mt-4 bg-slate-800 rounded p-3 grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-[10px] text-slate-500">ต้นทุนเฉลี่ย (Avg Cost)</div>
                        <div id="btc-avg-cost" class="font-mono text-sm text-slate-300">-</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-slate-500">Unrealized P/L</div>
                        <div id="btc-pl" class="font-mono font-bold text-sm text-slate-300">-</div>
                    </div>
                </div>
            </div>

            <!-- MSTR Tracker -->
            <div>
                <h4 class="text-red-500 font-bold mb-4 flex items-center"><i class="fa-solid fa-building-columns mr-2"></i>MSTR Status</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1">เงินลงทุนรวม (THB)</label>
                        <input type="number" id="mstr-invested" placeholder="0" class="w-full input-dark rounded px-3 py-2 text-sm font-mono" oninput="calcTracker()">
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1">จำนวนหุ้นที่มี (Share)</label>
                        <input type="number" id="mstr-amount" placeholder="0.00" step="0.01" class="w-full input-dark rounded px-3 py-2 text-sm font-mono" oninput="calcTracker()">
                    </div>
                </div>
                <div class="mt-4 bg-slate-800 rounded p-3 grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-[10px] text-slate-500">ต้นทุนเฉลี่ย (Avg Cost)</div>
                        <div id="mstr-avg-cost" class="font-mono text-sm text-slate-300">-</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-slate-500">Unrealized P/L</div>
                        <div id="mstr-pl" class="font-mono font-bold text-sm text-slate-300">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Google Sheet Sync Controls -->
        <div class="mt-6 pt-6 border-t border-slate-700 flex flex-col md:flex-row items-center justify-end gap-4">
            <button onclick="confirmSync()" id="btn-sync" class="px-6 py-3 rounded bg-green-600 text-white text-sm font-bold hover:bg-green-500 transition flex items-center shadow-lg shadow-green-900/50">
                <i class="fa-solid fa-cloud-arrow-up mr-2"></i>บันทึกข้อมูล (Sync)
            </button>
        </div>
    </section>

    <!-- CONFIRMATION MODAL -->
    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content text-center">
            <div class="mb-4 text-yellow-400 text-4xl">
                <i class="fa-solid fa-circle-question"></i>
            </div>
            <h3 class="text-lg font-bold text-white mb-2">ยืนยันการบันทึกข้อมูล?</h3>
            <p class="text-sm text-slate-400 mb-6">ข้อมูลการลงทุนปัจจุบันจะถูกส่งไปยัง Google Sheet ของคุณ</p>
            <div class="flex justify-center gap-3">
                <button onclick="closeConfirmModal()" class="px-5 py-2 rounded border border-slate-600 text-slate-300 hover:bg-slate-700 transition text-sm">ยกเลิก</button>
                <button onclick="executeSync()" class="px-5 py-2 rounded bg-green-600 text-white font-bold hover:bg-green-500 transition text-sm shadow-lg shadow-green-900/30">ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast">
        <div class="flex items-center gap-3">
            <div id="toast-icon" class="text-xl"></div>
            <div>
                <h4 id="toast-title" class="font-bold text-sm"></h4>
                <p id="toast-msg" class="text-xs text-slate-300 mt-0.5"></p>
            </div>
        </div>
    </div>

    <!-- Script Logic -->
    <script>
        // --- 1. Global State & Config ---
        // Your Google Apps Script Web App URL
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbySrBEEC3-DOPu_LYdS3KheQf6Obkbd2RBRSuv5slfUP3-xAeQqzhFaCVn3xqtwT4qE/exec";

        const state = {
            budget: 567000,
            allocation: 70, // 70% BTC
            exchangeRate: 34.50,
            strategy: 'wyckoff',
            btc: { 
                current: 2710000, 
                support: 2650000,
                volatility: 30000,
                history: []
            },
            mstr: { 
                current: 162.50, 
                support: 155.00,
                volatility: 3.5,
                history: []
            }
        };

        const strategies = {
            wyckoff: {
                name: "Wyckoff Sniper",
                desc: "40% ที่จุด SC (ราคาตลาด/แนวรับ) และ 60% รอ ST (ส่วนลด 2-3%)",
                steps: [
                    { pct: 0.40, offset: 0, label: "Zone 1 (SC)" }, 
                    { pct: 0.60, offset: -0.025, label: "Zone 2 (ST)" }
                ]
            },
            dca: {
                name: "DCA Step",
                desc: "แบ่ง 3 ไม้เท่ากัน ซื้อไล่ราคาลงมาทุกๆ 3-5%",
                steps: [
                    { pct: 0.33, offset: 0, label: "Step 1" },
                    { pct: 0.33, offset: -0.03, label: "Step 2 (-3%)" },
                    { pct: 0.34, offset: -0.06, label: "Step 3 (-6%)" }
                ]
            },
            pyramid: {
                name: "Pyramid Dip",
                desc: "ซื้อน้อยไปหามาก ยิ่งลงยิ่งซื้อหนัก (Aggressive)",
                steps: [
                    { pct: 0.20, offset: 0, label: "Tester" },
                    { pct: 0.30, offset: -0.04, label: "Dip Buy" },
                    { pct: 0.50, offset: -0.08, label: "Bottom Fish" }
                ]
            }
        };

        // --- 2. Wyckoff & Chart Utility Functions ---
        function generateWyckoffData(startPrice, volatility, trend = -1) {
            let data = [];
            let price = startPrice * 1.1; 
            for (let i = 0; i < 50; i++) {
                let change = (Math.random() - 0.5) * volatility;
                change += (trend * (volatility * 0.2)); 
                if (i > 35) change = (Math.random() - 0.5) * (volatility * 0.5); // Accumulation
                price += change;
                data.push(price);
            }
            data[data.length - 1] = startPrice;
            return data;
        }

        function calculateRSI(prices, period = 14) {
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                let diff = prices[i] - prices[i - 1];
                if (diff >= 0) gains += diff;
                else losses -= diff;
            }
            let rs = (gains/period) / (losses/period);
            return 100 - (100 / (1 + rs));
        }

        function calculateWyckoffScore(price, rsi, supportLevel) {
            let rsiScore = (100 - rsi) * 0.6; 
            if (rsiScore > 50) rsiScore = 50;
            let distToSupport = ((price - supportLevel) / supportLevel) * 100;
            let supportScore = 0;
            if (distToSupport <= 1) supportScore = 50; 
            else if (distToSupport <= 3) supportScore = 40;
            else if (distToSupport <= 5) supportScore = 20;
            else supportScore = 10;
            return Math.min(100, Math.max(0, Math.round(rsiScore + supportScore)));
        }

        function getPhase(score, rsi) {
            if (score >= 80) return "SPRING / SC";
            if (score >= 60) return "Accumulation (Phase B)";
            if (rsi < 30) return "Panic Sell (Wait for AR)";
            return "Markdown";
        }

        function getRecommendation(score) {
            if (score >= 80) return "STRONG BUY: เข้าไม้แรกทันที (Aggressive)";
            if (score >= 70) return "BUY: ทะยอยสะสม (Conservative)";
            if (score >= 50) return "WAIT: รอ Secondary Test";
            return "HOLD CASH: ตลาดยังลงแรง";
        }

        // --- 3. Chart Initialization ---
        state.btc.history = generateWyckoffData(state.btc.current, state.btc.volatility);
        state.mstr.history = generateWyckoffData(state.mstr.current, 4);

        function createChart(ctx, data, color) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(data.length).fill(''),
                    datasets: [{
                        data: data,
                        borderColor: color,
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        fill: { target: 'origin', above: color + '22' }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, min: Math.min(...data) * 0.99, max: Math.max(...data) * 1.01 }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        const btcChart = createChart(document.getElementById('btcChart').getContext('2d'), state.btc.history, '#eab308');
        const mstrChart = createChart(document.getElementById('mstrChart').getContext('2d'), state.mstr.history, '#ef4444');

        // --- 4. Logic & Update Loop ---
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                if (data && data.rates && data.rates.THB) {
                    state.exchangeRate = data.rates.THB;
                    document.getElementById('fx-source').innerText = "API Live";
                    document.getElementById('fx-status').classList.remove('bg-yellow-500');
                    document.getElementById('fx-status').classList.add('bg-green-500');
                }
            } catch (e) {
                console.log("FX API Failed, using simulation");
                state.exchangeRate += (Math.random() - 0.5) * 0.05;
                document.getElementById('fx-source').innerText = "Simulated";
            }
            document.getElementById('fx-rate').innerText = state.exchangeRate.toFixed(2);
            updateCalculations();
        }

        function updateAllocationDisplay() {
            const val = document.getElementById('allocation-slider').value;
            state.allocation = parseInt(val);
            state.budget = parseFloat(document.getElementById('input-budget').value) || 0;

            document.getElementById('btc-pct-display').innerText = `${state.allocation}%`;
            document.getElementById('mstr-pct-display').innerText = `${100 - state.allocation}%`;

            const btcAmt = state.budget * (state.allocation / 100);
            const mstrAmt = state.budget * ((100 - state.allocation) / 100);

            document.getElementById('btc-amt-display').innerText = formatCurrency(btcAmt);
            document.getElementById('mstr-amt-display').innerText = formatCurrency(mstrAmt);
            document.getElementById('btc-target-budget').innerText = formatCurrency(btcAmt);
            document.getElementById('mstr-target-budget').innerText = formatCurrency(mstrAmt);
            
            updateCalculations();
        }

        function setStrategy(stratKey) {
            state.strategy = stratKey;
            ['wyckoff', 'dca', 'pyramid'].forEach(k => {
                const btn = document.getElementById(`btn-${k}`);
                if (k === stratKey) btn.className = "p-2 rounded border border-blue-500 bg-blue-500/20 text-blue-300 text-xs font-bold transition shadow-[0_0_10px_rgba(59,130,246,0.3)]";
                else btn.className = "p-2 rounded border border-slate-600 bg-slate-700 text-slate-300 text-xs hover:bg-slate-600 transition opacity-60";
            });
            const s = strategies[stratKey];
            document.getElementById('strategy-desc').innerText = `Strategy: ${s.name}`;
            document.getElementById('strategy-detail').innerText = s.desc;
            updateCalculations();
        }

        function updateCalculations() {
            const btcBudget = state.budget * (state.allocation / 100);
            const mstrBudget = state.budget * ((100 - state.allocation) / 100);
            const strat = strategies[state.strategy];

            // Update BTC Ladder Table
            const btcTbody = document.getElementById('btc-ladder-body');
            btcTbody.innerHTML = '';
            strat.steps.forEach((step, index) => {
                const buyPrice = state.btc.current * (1 + step.offset);
                const amountTHB = btcBudget * step.pct;
                const tr = document.createElement('tr');
                tr.className = index === 0 ? "bg-yellow-500/10" : "";
                tr.innerHTML = `
                    <td class="font-bold text-slate-300">#${index + 1}</td>
                    <td class="text-blue-300">${step.label}</td>
                    <td class="font-mono text-white">${formatCurrency(buyPrice)}</td>
                    <td class="font-mono text-yellow-400 font-bold">${formatCurrency(amountTHB)}</td>
                `;
                btcTbody.appendChild(tr);
            });

            // Update MSTR Ladder Table
            const mstrTbody = document.getElementById('mstr-ladder-body');
            mstrTbody.innerHTML = '';
            strat.steps.forEach((step, index) => {
                const buyPriceUSD = state.mstr.current * (1 + step.offset);
                const amountTHB = mstrBudget * step.pct;
                const amountUSD = amountTHB / state.exchangeRate;
                const shares = amountUSD / buyPriceUSD;
                const tr = document.createElement('tr');
                tr.className = index === 0 ? "bg-red-500/10" : "";
                tr.innerHTML = `
                    <td class="font-bold text-slate-300">#${index + 1}</td>
                    <td class="font-mono text-white">$${buyPriceUSD.toFixed(2)}</td>
                    <td class="font-mono text-green-400 font-bold">${formatCurrency(amountTHB)}</td>
                    <td class="font-mono text-slate-400 text-xs">${shares.toFixed(4)} <span class="text-[10px]">shares</span></td>
                `;
                mstrTbody.appendChild(tr);
            });
            
            // Recalculate tracker with new prices
            calcTracker();
        }

        function updateAssetVisual(id, asset, chart, symbol) {
            // Simulate Price Tick
            let change = (Math.random() - 0.48) * (asset.volatility * 0.1); 
            asset.current += change;
            asset.history.push(asset.current);
            asset.history.shift();

            // Update Chart
            chart.data.datasets[0].data = asset.history;
            chart.options.scales.y.min = Math.min(...asset.history) * 0.995;
            chart.options.scales.y.max = Math.max(...asset.history) * 1.005;
            chart.update();

            // Wyckoff Indicators
            let rsi = calculateRSI(asset.history);
            let score = calculateWyckoffScore(asset.current, rsi, asset.support);
            let phase = getPhase(score, rsi);
            let rec = getRecommendation(score);

            // Update DOM Elements
            const priceEl = document.getElementById(`${id}-price`);
            priceEl.innerText = `${symbol}${asset.current.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            if(change > 0) {
                priceEl.classList.remove('text-white', 'text-red-400');
                priceEl.classList.add('text-green-400');
            } else {
                priceEl.classList.remove('text-white', 'text-green-400');
                priceEl.classList.add('text-red-400');
            }

            document.getElementById(`${id}-rsi`).innerText = rsi.toFixed(1);
            document.getElementById(`${id}-phase`).innerText = phase;
            document.getElementById(`${id}-score-text`).innerText = `${score}/100`;
            document.getElementById(`${id}-recommendation`).innerHTML = rec.includes("BUY") 
                ? `<i class="fa-solid fa-check-circle"></i> ${rec}` 
                : `<i class="fa-solid fa-hand"></i> ${rec}`;
            
            const gauge = document.getElementById(`${id}-gauge`);
            gauge.style.width = `${score}%`;
            if (score > 80) gauge.className = "gauge-fill bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.8)]";
            else if (score > 60) gauge.className = "gauge-fill bg-yellow-400";
            else gauge.className = "gauge-fill bg-slate-500";
        }

        function formatCurrency(num) {
            return "฿" + num.toLocaleString('th-TH', { maximumFractionDigits: 0 });
        }

        // --- 5. Tracker & Sheet Logic ---
        function calcTracker() {
            // BTC Logic
            const btcInvest = parseFloat(document.getElementById('btc-invested').value) || 0;
            const btcAmt = parseFloat(document.getElementById('btc-amount').value) || 0;
            if (btcInvest > 0 && btcAmt > 0) {
                const avg = btcInvest / btcAmt;
                const marketVal = btcAmt * state.btc.current;
                const pl = marketVal - btcInvest;
                
                document.getElementById('btc-avg-cost').innerText = formatCurrency(avg);
                const plEl = document.getElementById('btc-pl');
                plEl.innerText = formatCurrency(pl);
                plEl.className = pl >= 0 ? "font-mono font-bold text-sm text-green-400" : "font-mono font-bold text-sm text-red-400";
            } else {
                document.getElementById('btc-avg-cost').innerText = "-";
                document.getElementById('btc-pl').innerText = "-";
            }

            // MSTR Logic
            const mstrInvest = parseFloat(document.getElementById('mstr-invested').value) || 0;
            const mstrAmt = parseFloat(document.getElementById('mstr-amount').value) || 0;
            if (mstrInvest > 0 && mstrAmt > 0) {
                const avgTHB = mstrInvest / mstrAmt; // Avg cost per share in THB
                const marketValUSD = mstrAmt * state.mstr.current;
                const marketValTHB = marketValUSD * state.exchangeRate;
                const pl = marketValTHB - mstrInvest;

                document.getElementById('mstr-avg-cost').innerText = formatCurrency(avgTHB);
                const plEl = document.getElementById('mstr-pl');
                plEl.innerText = formatCurrency(pl);
                plEl.className = pl >= 0 ? "font-mono font-bold text-sm text-green-400" : "font-mono font-bold text-sm text-red-400";
            } else {
                document.getElementById('mstr-avg-cost').innerText = "-";
                document.getElementById('mstr-pl').innerText = "-";
            }
        }
        
        // --- Fetch Data from Sheet (NEW) ---
        async function fetchPortfolioData() {
             const statusIndicator = document.getElementById('fetch-status-indicator');
             const statusText = document.getElementById('fetch-status-text');
             
             statusIndicator.classList.remove('bg-slate-600');
             statusIndicator.classList.add('bg-yellow-500', 'animate-pulse');
             statusText.innerText = "Syncing...";

            try {
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();

                if (data.btc) {
                    document.getElementById('btc-invested').value = data.btc.invested;
                    document.getElementById('btc-amount').value = data.btc.amount;
                }
                if (data.mstr) {
                    document.getElementById('mstr-invested').value = data.mstr.invested;
                    document.getElementById('mstr-amount').value = data.mstr.amount;
                }

                // Recalculate
                calcTracker();
                
                statusIndicator.classList.remove('bg-yellow-500', 'animate-pulse');
                statusIndicator.classList.add('bg-green-500');
                statusText.innerText = "Synced";
                showToast("ดึงข้อมูลล่าสุดเรียบร้อย", "success");

            } catch (e) {
                console.error("Error fetching data:", e);
                statusIndicator.classList.remove('bg-yellow-500', 'animate-pulse');
                statusIndicator.classList.add('bg-red-500');
                statusText.innerText = "Error";
            }
        }

        // --- Modal & Sync Logic ---
        function confirmSync() {
            // Check if there is data to sync
            const btcInv = document.getElementById('btc-invested').value || 0;
            const mstrInv = document.getElementById('mstr-invested').value || 0;

            if (btcInv == 0 && mstrInv == 0) {
                showToast("ไม่พบข้อมูลการลงทุนให้บันทึก", "error");
                return;
            }

            const modal = document.getElementById('confirmModal');
            modal.style.display = "flex";
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.style.display = "none";
        }

        async function executeSync() {
            closeConfirmModal();
            const btn = document.getElementById('btn-sync');
            const originalText = btn.innerHTML;
            
            // Set Loading State
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> กำลังบันทึก...`;
            btn.className = "px-6 py-3 rounded bg-slate-600 text-slate-300 text-sm font-bold cursor-not-allowed flex items-center";

            try {
                // Prepare Timestamp
                const timestamp = new Date().toLocaleString('th-TH');
                const btcData = {
                    asset: 'BTC',
                    invested: document.getElementById('btc-invested').value || 0,
                    amount: document.getElementById('btc-amount').value || 0,
                    avgCost: document.getElementById('btc-avg-cost').innerText,
                    currentPrice: state.btc.current,
                    pl: document.getElementById('btc-pl').innerText,
                    timestamp: timestamp
                };
                const mstrData = {
                    asset: 'MSTR',
                    invested: document.getElementById('mstr-invested').value || 0,
                    amount: document.getElementById('mstr-amount').value || 0,
                    avgCost: document.getElementById('mstr-avg-cost').innerText,
                    currentPrice: state.mstr.current,
                    pl: document.getElementById('mstr-pl').innerText,
                    timestamp: timestamp
                };

                // Send Requests
                const promises = [];
                if(btcData.invested > 0) promises.push(sendData(WEB_APP_URL, btcData));
                if(mstrData.invested > 0) promises.push(sendData(WEB_APP_URL, mstrData));

                await Promise.all(promises);

                // Success
                showToast("บันทึกข้อมูลเรียบร้อยแล้ว", "success");

            } catch (error) {
                // Error
                console.error(error);
                showToast("เกิดข้อผิดพลาดในการบันทึก", "error");
            } finally {
                // Reset Button
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.className = "px-6 py-3 rounded bg-green-600 text-white text-sm font-bold hover:bg-green-500 transition flex items-center shadow-lg shadow-green-900/50";
                }, 1000);
            }
        }

        function sendData(url, data) {
            return fetch(url, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(data)
            });
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            const title = document.getElementById('toast-title');
            const msg = document.getElementById('toast-msg');
            const icon = document.getElementById('toast-icon');

            toast.className = `toast show ${type}`;
            
            if (type === 'success') {
                title.innerText = "Success!";
                msg.innerText = message;
                icon.innerHTML = '<i class="fa-solid fa-circle-check text-green-500"></i>';
                toast.style.boxShadow = "0 0 15px rgba(34, 197, 94, 0.4)";
            } else {
                title.innerText = "Error!";
                msg.innerText = message;
                icon.innerHTML = '<i class="fa-solid fa-circle-xmark text-red-500"></i>';
                toast.style.boxShadow = "0 0 15px rgba(239, 68, 68, 0.4)";
            }

            // Hide after 3 seconds
            setTimeout(() => {
                toast.className = toast.className.replace("show", "");
            }, 3000);
        }

        // Window click to close modal if clicked outside
        window.onclick = function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target == modal) {
                closeConfirmModal();
            }
        }

        function mainLoop() {
            updateAssetVisual('btc', state.btc, btcChart, '฿');
            updateAssetVisual('mstr', state.mstr, mstrChart, '$');
            updateCalculations(); 
        }

        // --- Init ---
        // Add Fetch on load
        fetchPortfolioData();

        updateAllocationDisplay(); 
        setStrategy('wyckoff');
        setInterval(mainLoop, 1500); 
        setInterval(fetchExchangeRate, 60000); 
        fetchExchangeRate();

    </script>
</body>
</html>
