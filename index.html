<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyckoff Logic Pro: MTF Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .card-gradient {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            box-shadow: 5px 5px 10px #0b1120, -5px -5px 10px #27354d;
        }
        .input-dark {
            background-color: #334155; border: 1px solid #475569; color: white; transition: all 0.3s;
        }
        .input-dark:focus { border-color: #3b82f6; outline: none; }
        .gauge-container {
            position: relative; width: 100%; height: 12px; background: #334155; border-radius: 6px; overflow: hidden;
        }
        .gauge-fill { height: 100%; transition: width 0.5s ease-in-out, background-color 0.5s; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; }
        
        .ladder-table th { text-align: left; padding: 8px; font-size: 0.75rem; color: #94a3b8; border-bottom: 1px solid #334155; }
        .ladder-table td { padding: 8px; font-size: 0.85rem; border-bottom: 1px solid #1e293b; }

        /* TradingView Widget Container */
        .tv-widget-container { height: 320px; width: 100%; border-radius: 12px; overflow: hidden; border: 1px solid #334155; margin-top: 1rem; }

        /* TF Grid */
        .tf-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-top: 12px; }
        .tf-box { background: #334155; border-radius: 6px; padding: 6px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50px; }
        .tf-label { font-size: 0.65rem; color: #94a3b8; font-weight: bold; margin-bottom: 2px; }
        .tf-score { font-size: 0.9rem; font-weight: bold; font-family: 'JetBrains Mono', monospace; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-2 md:p-4 pb-32 max-w-7xl mx-auto">

    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-400">
                <i class="fa-solid fa-layer-group mr-2"></i>Wyckoff Logic Pro
            </h1>
            <p class="text-xs text-slate-400">Multi-Timeframe Analysis & Real-Time Data</p>
        </div>
        
        <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700 flex items-center gap-3">
            <div class="text-xs text-slate-400"><i class="fa-solid fa-money-bill-transfer mr-1"></i>USD/THB</div>
            <div class="text-lg font-mono font-bold text-yellow-400" id="fx-rate">...</div>
        </div>
    </header>

    <section class="grid md:grid-cols-2 gap-6 mb-8">
        
        <div id="btc-card" class="card-gradient rounded-2xl p-5 border-l-4 border-yellow-500 relative overflow-hidden">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-bold text-yellow-500">BTC / THB</h2>
                    <p class="text-xs text-slate-400">Bitkub (Multi-Timeframe Wyckoff)</p>
                </div>
                <div class="text-right">
                    <div id="btc-price" class="text-2xl font-mono font-bold text-white">Loading...</div>
                    <div id="btc-change" class="text-xs font-bold text-slate-500">...</div>
                </div>
            </div>

            <div class="bg-slate-900/50 rounded-lg p-3 mb-4 backdrop-blur-sm border border-slate-700">
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-400">Overall Score</span><span id="btc-score-text" class="font-bold text-white">Calculating...</span>
                </div>
                <div class="gauge-container mt-1">
                    <div id="btc-gauge" class="gauge-fill bg-slate-500" style="width: 0%;"></div>
                </div>
                <p id="btc-recommendation" class="text-xs mt-2 text-center text-green-400 font-bold">Waiting for data...</p>
            </div>

            <div class="tv-widget-container" id="tv-btc-container"></div>
            
            <div class="mt-4 border-t border-slate-700 pt-3">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-[10px] text-slate-400 font-bold"><i class="fa-solid fa-clock mr-1"></i>Wyckoff Score by Timeframe</div>
                    <div id="btc-mtf-status" class="text-[9px] text-slate-500"><i class="fa-solid fa-spinner loading-spin mr-1"></i>Analyzing...</div>
                </div>
                <div class="tf-grid" id="btc-tf-grid">
                    <div class="tf-box"><span class="tf-label">1 Hr</span><span class="tf-score text-slate-500">-</span></div>
                    <div class="tf-box"><span class="tf-label">4 Hr</span><span class="tf-score text-slate-500">-</span></div>
                    <div class="tf-box"><span class="tf-label">1 Day</span><span class="tf-score text-slate-500">-</span></div>
                    <div class="tf-box"><span class="tf-label">3 Day</span><span class="tf-score text-slate-500">-</span></div>
                    <div class="tf-box"><span class="tf-label">1 Week</span><span class="tf-score text-slate-500">-</span></div>
                </div>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2 text-center">
                <div class="bg-slate-800 rounded p-1"><div class="text-[10px] text-slate-400">Day Support</div><div class="text-xs font-mono text-green-400" id="btc-support">-</div></div>
                <div class="bg-slate-800 rounded p-1"><div class="text-[10px] text-slate-400">Day Resistance</div><div class="text-xs font-mono text-red-400" id="btc-res">-</div></div>
            </div>
        </div>

        <div id="mstr-card" class="card-gradient rounded-2xl p-5 border-l-4 border-red-500 relative overflow-hidden">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-bold text-red-500">MSTR</h2>
                    <p class="text-xs text-slate-400">NASDAQ (Multi-Timeframe Wyckoff)</p>
                </div>
                <div class="text-right">
                    <div id="mstr-price" class="text-2xl font-mono font-bold text-white">Loading...</div>
                    <div id="mstr-change" class="text-xs font-bold text-slate-500">...</div>
                </div>
            </div>

            <div class="bg-slate-900/50 rounded-lg p-3 mb-4 backdrop-blur-sm border border-slate-700">
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-400">Overall Score</span><span id="mstr-score-text" class="font-bold text-white">Calculating...</span>
                </div>
                <div class="gauge-container mt-1">
                    <div id="mstr-gauge" class="gauge-fill bg-slate-500" style="width: 0%;"></div>
                </div>
                <p id="mstr-recommendation" class="text-xs mt-2 text-center text-green-400 font-bold">Waiting for data...</p>
            </div>

            <div class="tv-widget-container" id="tv-mstr-container"></div>

            <div class="mt-4 border-t border-slate-700 pt-3">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-[10px] text-slate-400 font-bold"><i class="fa-solid fa-clock mr-1"></i>Wyckoff Score by Timeframe</div>
                    <div id="mstr-mtf-status" class="text-[9px] text-slate-500"><i class="fa-solid fa-spinner loading-spin mr-1"></i>Analyzing...</div>
                </div>
                <div class="tf-grid" id="mstr-tf-grid">
                    <div class="tf-box"><span class="tf-label">1 Hr</span><span class="tf-score text-slate-500">-</span></div>
                    <div class="tf-box"><span class="tf-label">4 Hr</span><span class="tf-score text-slate-500">-</span></div>
                    <div class="tf-box"><span class="tf-label">1 Day</span><span class="tf-score text-slate-500">-</span></div>
                    <div class="tf-box"><span class="tf-label">3 Day</span><span class="tf-score text-slate-500">-</span></div>
                    <div class="tf-box"><span class="tf-label">1 Week</span><span class="tf-score text-slate-500">-</span></div>
                </div>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2 text-center">
                <div class="bg-slate-800 rounded p-1"><div class="text-[10px] text-slate-400">Day Support</div><div class="text-xs font-mono text-green-400" id="mstr-support">-</div></div>
                <div class="bg-slate-800 rounded p-1"><div class="text-[10px] text-slate-400">Day Resistance</div><div class="text-xs font-mono text-red-400" id="mstr-res">-</div></div>
            </div>
        </div>
    </section>

    <section class="grid md:grid-cols-12 gap-6 mb-6">
        <div class="md:col-span-5 bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
            <h3 class="text-sm font-bold text-white mb-4 border-b border-slate-700 pb-2"><i class="fa-solid fa-sliders mr-2"></i>Portfolio Configuration</h3>
            <div class="mb-5">
                <label class="block text-xs text-slate-400 mb-1">งบประมาณลงทุน (THB)</label>
                <div class="relative">
                    <span class="absolute left-3 top-2.5 text-slate-400">฿</span>
                    <input type="number" id="input-budget" value="567000" class="w-full input-dark rounded pl-8 pr-3 py-2 font-mono text-lg font-bold text-green-400 focus:text-white" oninput="updateCalculations()">
                </div>
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-xs mb-2">
                    <span class="text-yellow-500 font-bold"><i class="fa-brands fa-bitcoin"></i> BTC <span id="btc-pct-display">70%</span></span>
                    <span class="text-red-500 font-bold">MSTR <span id="mstr-pct-display">30%</span> <i class="fa-solid fa-building"></i></span>
                </div>
                <input type="range" id="allocation-slider" min="0" max="100" value="70" class="mb-2" oninput="updateAllocationDisplay()">
                <div class="flex justify-between text-xs font-mono text-slate-400">
                    <span id="btc-amt-display">...</span>
                    <span id="mstr-amt-display">...</span>
                </div>
            </div>
        </div>

        <div class="md:col-span-7 bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
            <h3 class="text-sm font-bold text-white mb-4 border-b border-slate-700 pb-2"><i class="fa-solid fa-chess-knight mr-2"></i>Ladder Strategy</h3>
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="setStrategy('wyckoff')" id="btn-wyckoff" class="p-2 rounded border border-blue-500 bg-blue-500/20 text-blue-300 text-xs font-bold transition">Wyckoff Sniper</button>
                <button onclick="setStrategy('dca')" id="btn-dca" class="p-2 rounded border border-slate-600 bg-slate-700 text-slate-300 text-xs hover:bg-slate-600 transition">DCA Step</button>
                <button onclick="setStrategy('pyramid')" id="btn-pyramid" class="p-2 rounded border border-slate-600 bg-slate-700 text-slate-300 text-xs hover:bg-slate-600 transition">Pyramid Dip</button>
            </div>
            <div class="bg-slate-900/50 p-3 rounded border border-slate-700 text-xs">
                <div id="strategy-desc" class="text-blue-200 mb-1 font-bold">Strategy: Wyckoff Sniper</div>
                <div id="strategy-detail" class="text-slate-400">...</div>
            </div>
        </div>
    </section>

    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <div class="card-gradient rounded-xl p-4 border-l-4 border-yellow-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-yellow-500"><i class="fa-brands fa-bitcoin mr-2"></i>BTC Buy Ladder</h3>
                <div class="font-mono font-bold text-white" id="btc-target-budget">฿0</div>
            </div>
            <table class="w-full ladder-table">
                <thead><tr><th>Order</th><th>Condition</th><th>Price (THB)</th><th>Amount (THB)</th></tr></thead>
                <tbody id="btc-ladder-body"></tbody>
            </table>
        </div>
        <div class="card-gradient rounded-xl p-4 border-l-4 border-red-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-red-500"><i class="fa-solid fa-building-columns mr-2"></i>MSTR Buy Ladder</h3>
                <div class="font-mono font-bold text-white" id="mstr-target-budget">฿0</div>
            </div>
            <table class="w-full ladder-table">
                <thead><tr><th>Order</th><th>Price ($)</th><th>Est. Cost (THB)</th><th>Shares</th></tr></thead>
                <tbody id="mstr-ladder-body"></tbody>
            </table>
        </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // --- PROXY & API CONFIG ---
        const CORS_PROXY = "https://api.allorigins.win/raw?url=";
        const TIMEFRAMES = ['1h', '4h', '1d', '3d', '1w'];

        const state = {
            budget: 567000,
            allocation: 70,
            exchangeRate: 34.50, 
            strategy: 'wyckoff',
            btc: { current: 0, support: 0, resistance: 0 },
            mstr: { current: 160.00, support: 0, resistance: 0 } 
        };

        const strategies = {
            wyckoff: { name: "Wyckoff Sniper", desc: "40% ที่จุด SC / 60% ที่จุด ST", steps: [{pct:0.4, offset:0, label:"Zone SC"}, {pct:0.6, offset:-0.025, label:"Zone ST"}] },
            dca: { name: "DCA Step", desc: "แบ่ง 3 ไม้เท่ากัน", steps: [{pct:0.33, offset:0, label:"Step 1"}, {pct:0.33, offset:-0.03, label:"Step 2"}, {pct:0.34, offset:-0.06, label:"Step 3"}] },
            pyramid: { name: "Pyramid Dip", desc: "ยิ่งลงยิ่งซื้อเยอะ", steps: [{pct:0.2, offset:0, label:"Test"}, {pct:0.3, offset:-0.04, label:"Dip"}, {pct:0.5, offset:-0.08, label:"Bottom"}] }
        };

        // --- INIT TRADINGVIEW WIDGETS ---
        function initTradingView() {
            new TradingView.widget({
                "autosize": true, "symbol": "BITKUB:BTCTHB", "interval": "60", "timezone": "Asia/Bangkok",
                "theme": "dark", "style": "1", "locale": "en", "toolbar_bg": "#f1f3f6", "enable_publishing": false,
                "hide_top_toolbar": true, "hide_legend": false, "container_id": "tv-btc-container", "backgroundColor": "rgba(15, 23, 42, 1)"
            });
            new TradingView.widget({
                "autosize": true, "symbol": "NASDAQ:MSTR", "interval": "D", "timezone": "Asia/Bangkok",
                "theme": "dark", "style": "1", "locale": "en", "toolbar_bg": "#f1f3f6", "enable_publishing": false,
                "hide_top_toolbar": true, "hide_legend": false, "container_id": "tv-mstr-container", "backgroundColor": "rgba(15, 23, 42, 1)"
            });
        }

        // --- CORE DATA FETCHING (PARALLEL & RESAMPLING) ---

        // 1. Fetch BTC Logic (Bitkub)
        async function updateBTCLogic() {
            document.getElementById('btc-mtf-status').innerHTML = '<i class="fa-solid fa-spinner loading-spin mr-1"></i>Updating...';
            try {
                // Fetch Price Ticker
                const tickerUrl = CORS_PROXY + encodeURIComponent("https://api.bitkub.com/api/market/ticker?sym=THB_BTC");
                const tickerRes = await fetch(tickerUrl);
                const tickerData = await tickerRes.json();
                
                if (tickerData && tickerData.THB_BTC) {
                    state.btc.current = tickerData.THB_BTC.last;
                    updatePriceUI('btc', state.btc.current, tickerData.THB_BTC.percentChange, '฿');
                }

                // Fetch Candles for Logic (Optimization: Fetch 1H and 1D, then resample for others)
                // 1H Data (for 1h, 4h)
                const url1h = CORS_PROXY + encodeURIComponent("https://api.bitkub.com/api/market/candles?sym=THB_BTC&int=60&lmt=100");
                // 1D Data (for 1d, 3d, 1w)
                const url1d = CORS_PROXY + encodeURIComponent("https://api.bitkub.com/api/market/candles?sym=THB_BTC&int=1440&lmt=100");

                const [res1h, res1d] = await Promise.all([fetch(url1h), fetch(url1d)]);
                const data1h = await res1h.json();
                const data1d = await res1d.json();

                if(data1h.result && data1d.result) {
                    const closes1h = data1h.result.map(c => c[4]);
                    const closes1d = data1d.result.map(c => c[4]);

                    // Resample Logic
                    const closes4h = resampleCandles(closes1h, 4);
                    const closes3d = resampleCandles(closes1d, 3);
                    const closes1w = resampleCandles(closes1d, 7);

                    // Update UI Grid
                    const scores = [];
                    scores.push(processTimeframe('btc', '1 Hr', 0, closes1h, state.btc.current));
                    scores.push(processTimeframe('btc', '4 Hr', 1, closes4h, state.btc.current));
                    scores.push(processTimeframe('btc', '1 Day', 2, closes1d, state.btc.current));
                    scores.push(processTimeframe('btc', '3 Day', 3, closes3d, state.btc.current));
                    scores.push(processTimeframe('btc', '1 Week', 4, closes1w, state.btc.current));

                    // Update Main Gauge (Average of 4H and 1D)
                    const avgScore = (scores[1] + scores[2]) / 2;
                    updateMainGauge('btc', avgScore);

                    // Update Support/Res (Based on 1D)
                    const lows = data1d.result.map(c=>c[3]);
                    const highs = data1d.result.map(c=>c[2]);
                    state.btc.support = Math.min(...lows.slice(-30));
                    state.btc.resistance = Math.max(...highs.slice(-30));
                    updateUIStats('btc');
                }
                document.getElementById('btc-mtf-status').innerText = "Updated";

            } catch(e) {
                console.error("BTC Logic Error", e);
                document.getElementById('btc-mtf-status').innerText = "Retry in 10s";
                if(state.btc.current === 0) { state.btc.current = 3350000; updateCalculations(); } // Fallback
            }
        }

        // 2. Fetch MSTR Logic (Yahoo Finance)
        async function updateMSTRLogic() {
            document.getElementById('mstr-mtf-status').innerHTML = '<i class="fa-solid fa-spinner loading-spin mr-1"></i>Updating...';
            try {
                // Fetch 1H and 1D Data
                const url1h = CORS_PROXY + encodeURIComponent("https://query1.finance.yahoo.com/v8/finance/chart/MSTR?interval=60m&range=1mo");
                const url1d = CORS_PROXY + encodeURIComponent("https://query1.finance.yahoo.com/v8/finance/chart/MSTR?interval=1d&range=6mo");

                const [res1h, res1d] = await Promise.all([fetch(url1h), fetch(url1d)]);
                const json1h = await res1h.json();
                const json1d = await res1d.json();

                const quote1h = json1h.chart.result[0];
                const quote1d = json1d.chart.result[0];

                // Update Price
                state.mstr.current = quote1d.meta.regularMarketPrice;
                const prev = quote1d.meta.chartPreviousClose;
                updatePriceUI('mstr', state.mstr.current, ((state.mstr.current-prev)/prev)*100, '$');

                // Extract Clean Data
                const getCloses = (q) => q.indicators.quote[0].close.filter(c => c !== null);
                const closes1h = getCloses(quote1h);
                const closes1d = getCloses(quote1d);

                // Resample
                const closes4h = resampleCandles(closes1h, 4); // Approx 4 hours (market hours)
                const closes3d = resampleCandles(closes1d, 3);
                const closes1w = resampleCandles(closes1d, 5); // 5 trading days = 1 week approx

                // Update UI Grid
                const scores = [];
                scores.push(processTimeframe('mstr', '1 Hr', 0, closes1h, state.mstr.current));
                scores.push(processTimeframe('mstr', '4 Hr', 1, closes4h, state.mstr.current));
                scores.push(processTimeframe('mstr', '1 Day', 2, closes1d, state.mstr.current));
                scores.push(processTimeframe('mstr', '3 Day', 3, closes3d, state.mstr.current));
                scores.push(processTimeframe('mstr', '1 Week', 4, closes1w, state.mstr.current));

                // Update Main Gauge
                const avgScore = (scores[1] + scores[2]) / 2;
                updateMainGauge('mstr', avgScore);

                 // Update Support/Res
                const lows = quote1d.indicators.quote[0].low.filter(c => c !== null);
                const highs = quote1d.indicators.quote[0].high.filter(c => c !== null);
                state.mstr.support = Math.min(...lows.slice(-20));
                state.mstr.resistance = Math.max(...highs.slice(-20));
                updateUIStats('mstr');
                
                document.getElementById('mstr-mtf-status').innerText = "Updated";
                updateCalculations();

            } catch(e) {
                console.error("MSTR Logic Error", e);
                document.getElementById('mstr-mtf-status').innerText = "Retry in 1m";
            }
        }

        async function fetchFX() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await res.json();
                state.exchangeRate = data.rates.THB;
                document.getElementById('fx-rate').innerText = state.exchangeRate.toFixed(2);
            } catch(e) {}
        }

        // --- LOGIC ENGINE ---

        function resampleCandles(closes, period) {
            // Simple resampling: Take every Nth close
            // Better: We should ideally take the close of the Nth candle, but simpler is fine for logic estimation
            let resampled = [];
            for (let i = period - 1; i < closes.length; i += period) {
                resampled.push(closes[i]);
            }
            // If data is short, return original
            return resampled.length > 10 ? resampled : closes;
        }

        function calculateRSI(prices, period=14) {
            if(prices.length < period + 1) return 50;
            let gains = 0, losses = 0;
            for(let i = prices.length - period; i < prices.length; i++) {
                let diff = prices[i] - prices[i - 1];
                if(diff >= 0) gains += diff; else losses -= diff;
            }
            if(losses === 0) return 100;
            return 100 - (100 / (1 + (gains / losses)));
        }

        function calculateWyckoffScore(current, history) {
            const rsi = calculateRSI(history);
            // Dynamic Support from recent history
            const lookback = Math.min(history.length, 30);
            const recent = history.slice(-lookback);
            const support = Math.min(...recent);
            
            let score = 50; // Base
            const dist = ((current - support) / support) * 100;

            // Scoring Logic
            if (dist < 2) score += 30; // Close to support (Spring potential)
            else if (dist < 5) score += 15;
            else if (dist > 15) score -= 10; // Too high

            if (rsi < 35) score += 20; // Oversold
            else if (rsi > 70) score -= 20; // Overbought
            else if (rsi > 50) score += 5; // Momentum

            return Math.max(0, Math.min(100, Math.round(score)));
        }

        function processTimeframe(asset, label, index, history, current) {
            const score = calculateWyckoffScore(current, history);
            const container = document.getElementById(`${asset}-tf-grid`);
            const boxes = container.getElementsByClassName('tf-box');
            
            // Color Logic
            let colorClass = "text-slate-500";
            if (score >= 70) colorClass = "text-green-400";
            else if (score >= 50) colorClass = "text-yellow-400";
            else if (score < 40) colorClass = "text-red-400";

            boxes[index].innerHTML = `<span class="tf-label">${label}</span><span class="tf-score ${colorClass}">${score}</span>`;
            return score;
        }

        function updateMainGauge(id, score) {
            score = Math.round(score);
            document.getElementById(`${id}-score-text`).innerText = `${score}/100`;
            const g = document.getElementById(`${id}-gauge`);
            g.style.width = `${score}%`;
            
            let rec = "WAIT";
            let color = "bg-slate-500";
            
            if(score >= 75) { rec = "STRONG BUY (SC/Spring)"; color = "bg-green-500"; }
            else if(score >= 60) { rec = "ACCUMULATE (Phase B)"; color = "bg-yellow-400"; }
            else if(score <= 40) { rec = "DISTRIBUTION / SELL"; color = "bg-red-500"; }
            else { rec = "NEUTRAL / HOLD"; color = "bg-slate-500"; }

            g.className = `gauge-fill ${color}`;
            document.getElementById(`${id}-recommendation`).innerText = rec;
        }

        // --- UI & CALCULATIONS ---
        function updatePriceUI(id, price, changePct, symbol) {
            const pEl = document.getElementById(`${id}-price`);
            pEl.innerText = `${symbol}${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            const cEl = document.getElementById(`${id}-change`);
            cEl.innerText = `${changePct>0?'+':''}${changePct.toFixed(2)}%`;
            cEl.className = changePct>=0?"text-xs font-bold text-green-400":"text-xs font-bold text-red-400";
            if(changePct>=0) pEl.classList.replace('text-red-400','text-green-400'); else pEl.classList.replace('text-green-400','text-red-400');
        }

        function updateUIStats(id) {
            document.getElementById(`${id}-support`).innerText = (id==='btc'?'฿':'$') + state[id].support.toLocaleString(undefined,{maximumFractionDigits:0});
            document.getElementById(`${id}-res`).innerText = (id==='btc'?'฿':'$') + state[id].resistance.toLocaleString(undefined,{maximumFractionDigits:0});
        }

        function updateCalculations() {
            state.budget = parseFloat(document.getElementById('input-budget').value)||0;
            const btcAlloc = state.budget * (state.allocation/100);
            const mstrAlloc = state.budget - btcAlloc;
            const strat = strategies[state.strategy];

            document.getElementById('btc-target-budget').innerText = "฿"+btcAlloc.toLocaleString(undefined, {maximumFractionDigits:0});
            document.getElementById('mstr-target-budget').innerText = "฿"+mstrAlloc.toLocaleString(undefined, {maximumFractionDigits:0});
            document.getElementById('btc-amt-display').innerText = "฿"+btcAlloc.toLocaleString(undefined, {maximumFractionDigits:0});
            document.getElementById('mstr-amt-display').innerText = "฿"+mstrAlloc.toLocaleString(undefined, {maximumFractionDigits:0});

            // BTC Ladder
            const btcBody = document.getElementById('btc-ladder-body');
            btcBody.innerHTML = '';
            strat.steps.forEach((s,i) => {
                const px = state.btc.current * (1+s.offset);
                const amt = btcAlloc * s.pct;
                btcBody.innerHTML += `<tr><td class="text-slate-400">#${i+1}</td><td class="text-blue-300 text-xs">${s.label}</td><td class="font-mono">฿${px.toLocaleString(undefined,{maximumFractionDigits:0})}</td><td class="font-mono text-yellow-400">฿${amt.toLocaleString(undefined,{maximumFractionDigits:0})}</td></tr>`;
            });

            // MSTR Ladder
            const mstrBody = document.getElementById('mstr-ladder-body');
            mstrBody.innerHTML = '';
            strat.steps.forEach((s,i) => {
                const pxUSD = state.mstr.current * (1+s.offset);
                const amtTHB = mstrAlloc * s.pct;
                const shares = (amtTHB / state.exchangeRate) / pxUSD;
                mstrBody.innerHTML += `<tr><td class="text-slate-400">#${i+1}</td><td class="font-mono text-xs">$${pxUSD.toFixed(2)}</td><td class="font-mono text-green-400">฿${amtTHB.toLocaleString(undefined,{maximumFractionDigits:0})}</td><td class="font-mono text-slate-400 text-xs">${shares.toFixed(4)}</td></tr>`;
            });
        }

        function updateAllocationDisplay() { state.allocation = parseInt(document.getElementById('allocation-slider').value); document.getElementById('btc-pct-display').innerText = state.allocation+"%"; document.getElementById('mstr-pct-display').innerText = (100-state.allocation)+"%"; updateCalculations(); }
        function setStrategy(s) { state.strategy = s; ['wyckoff','dca','pyramid'].forEach(k=>document.getElementById('btn-'+k).className = k===s?"p-2 rounded border border-blue-500 bg-blue-500/20 text-blue-300 text-xs font-bold transition":"p-2 rounded border border-slate-600 bg-slate-700 text-slate-300 text-xs hover:bg-slate-600 transition opacity-60"); document.getElementById('strategy-desc').innerText="Strategy: "+strategies[s].name; updateCalculations(); }

        // --- STARTUP ---
        initTradingView();
        fetchFX();
        
        // Initial Fetch
        updateBTCLogic();
        updateMSTRLogic();

        // Loop (Less frequent to avoid bans)
        setInterval(updateBTCLogic, 20000); // 20s
        setInterval(updateMSTRLogic, 60000); // 60s
        updateAllocationDisplay();

    </script>
</body>
</html>
