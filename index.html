<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyckoff Logic Pro: TradingView Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .card-gradient {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            box-shadow: 5px 5px 10px #0b1120, -5px -5px 10px #27354d;
        }
        .input-dark {
            background-color: #334155; border: 1px solid #475569; color: white; transition: all 0.3s;
        }
        .input-dark:focus { border-color: #3b82f6; outline: none; }
        .gauge-container {
            position: relative; width: 100%; height: 12px; background: #334155; border-radius: 6px; overflow: hidden;
        }
        .gauge-fill { height: 100%; transition: width 0.5s ease-in-out, background-color 0.5s; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; }
        
        .ladder-table th { text-align: left; padding: 8px; font-size: 0.75rem; color: #94a3b8; border-bottom: 1px solid #334155; }
        .ladder-table td { padding: 8px; font-size: 0.85rem; border-bottom: 1px solid #1e293b; }

        /* TradingView Widget Container */
        .tv-widget-container { height: 300px; width: 100%; border-radius: 12px; overflow: hidden; border: 1px solid #334155; }
    </style>
</head>
<body class="min-h-screen p-2 md:p-4 pb-32 max-w-7xl mx-auto">

    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-400">
                <i class="fa-solid fa-layer-group mr-2"></i>Wyckoff Logic Pro
            </h1>
            <p class="text-xs text-slate-400">TradingView Chart & Live Data Integration</p>
        </div>
        
        <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700 flex items-center gap-3">
            <div class="text-xs text-slate-400"><i class="fa-solid fa-money-bill-transfer mr-1"></i>USD/THB</div>
            <div class="text-lg font-mono font-bold text-yellow-400" id="fx-rate">...</div>
        </div>
    </header>

    <section class="grid md:grid-cols-2 gap-6 mb-8">
        
        <div id="btc-card" class="card-gradient rounded-2xl p-5 border-l-4 border-yellow-500 relative overflow-hidden">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-bold text-yellow-500">BTC / THB</h2>
                    <p class="text-xs text-slate-400">Bitkub Exchange (Live)</p>
                </div>
                <div class="text-right">
                    <div id="btc-price" class="text-2xl font-mono font-bold text-white">Loading...</div>
                    <div id="btc-change" class="text-xs font-bold text-slate-500">...</div>
                </div>
            </div>

            <div class="bg-slate-900/50 rounded-lg p-3 mb-4 backdrop-blur-sm border border-slate-700">
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-400">RSI (14)</span><span id="btc-rsi" class="font-bold text-yellow-300">-</span>
                </div>
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-400">Score</span><span id="btc-score-text" class="font-bold text-white">0/100</span>
                </div>
                <div class="gauge-container mt-1">
                    <div id="btc-gauge" class="gauge-fill bg-slate-500" style="width: 0%;"></div>
                </div>
                <p id="btc-recommendation" class="text-xs mt-2 text-center text-green-400 font-bold">Waiting...</p>
            </div>

            <div class="h-48 w-full">
                <canvas id="btcChart"></canvas>
            </div>
            
            <div class="mt-3 grid grid-cols-2 gap-2 text-center">
                <div class="bg-slate-800 rounded p-1"><div class="text-[10px] text-slate-400">Support</div><div class="text-xs font-mono text-green-400" id="btc-support">-</div></div>
                <div class="bg-slate-800 rounded p-1"><div class="text-[10px] text-slate-400">Resistance</div><div class="text-xs font-mono text-red-400" id="btc-res">-</div></div>
            </div>
        </div>

        <div id="mstr-card" class="card-gradient rounded-2xl p-5 border-l-4 border-red-500 relative overflow-hidden">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-bold text-red-500">MSTR</h2>
                    <p class="text-xs text-slate-400">NASDAQ (Real-time via Proxy)</p>
                </div>
                <div class="text-right">
                    <div id="mstr-price" class="text-2xl font-mono font-bold text-white">Loading...</div>
                    <div id="mstr-change" class="text-xs font-bold text-slate-500">...</div>
                </div>
            </div>

            <div class="bg-slate-900/50 rounded-lg p-3 mb-4 backdrop-blur-sm border border-slate-700">
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-400">RSI (14)</span><span id="mstr-rsi" class="font-bold text-red-300">-</span>
                </div>
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-400">Score</span><span id="mstr-score-text" class="font-bold text-white">0/100</span>
                </div>
                <div class="gauge-container mt-1">
                    <div id="mstr-gauge" class="gauge-fill bg-slate-500" style="width: 0%;"></div>
                </div>
                <p id="mstr-recommendation" class="text-xs mt-2 text-center text-green-400 font-bold">Waiting...</p>
            </div>

            <div class="tv-widget-container" id="tv-chart-container">
                <div class="flex items-center justify-center h-full text-xs text-slate-500">Loading TradingView...</div>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2 text-center">
                <div class="bg-slate-800 rounded p-1"><div class="text-[10px] text-slate-400">Support</div><div class="text-xs font-mono text-green-400" id="mstr-support">-</div></div>
                <div class="bg-slate-800 rounded p-1"><div class="text-[10px] text-slate-400">Resistance</div><div class="text-xs font-mono text-red-400" id="mstr-res">-</div></div>
            </div>
        </div>
    </section>

    <section class="grid md:grid-cols-12 gap-6 mb-6">
        <div class="md:col-span-5 bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
            <h3 class="text-sm font-bold text-white mb-4 border-b border-slate-700 pb-2"><i class="fa-solid fa-sliders mr-2"></i>Portfolio Configuration</h3>
            <div class="mb-5">
                <label class="block text-xs text-slate-400 mb-1">งบประมาณลงทุน (THB)</label>
                <div class="relative">
                    <span class="absolute left-3 top-2.5 text-slate-400">฿</span>
                    <input type="number" id="input-budget" value="567000" class="w-full input-dark rounded pl-8 pr-3 py-2 font-mono text-lg font-bold text-green-400 focus:text-white" oninput="updateCalculations()">
                </div>
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-xs mb-2">
                    <span class="text-yellow-500 font-bold"><i class="fa-brands fa-bitcoin"></i> BTC <span id="btc-pct-display">70%</span></span>
                    <span class="text-red-500 font-bold">MSTR <span id="mstr-pct-display">30%</span> <i class="fa-solid fa-building"></i></span>
                </div>
                <input type="range" id="allocation-slider" min="0" max="100" value="70" class="mb-2" oninput="updateAllocationDisplay()">
                <div class="flex justify-between text-xs font-mono text-slate-400">
                    <span id="btc-amt-display">...</span>
                    <span id="mstr-amt-display">...</span>
                </div>
            </div>
        </div>

        <div class="md:col-span-7 bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
            <h3 class="text-sm font-bold text-white mb-4 border-b border-slate-700 pb-2"><i class="fa-solid fa-chess-knight mr-2"></i>Ladder Strategy</h3>
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="setStrategy('wyckoff')" id="btn-wyckoff" class="p-2 rounded border border-blue-500 bg-blue-500/20 text-blue-300 text-xs font-bold transition">Wyckoff Sniper</button>
                <button onclick="setStrategy('dca')" id="btn-dca" class="p-2 rounded border border-slate-600 bg-slate-700 text-slate-300 text-xs hover:bg-slate-600 transition">DCA Step</button>
                <button onclick="setStrategy('pyramid')" id="btn-pyramid" class="p-2 rounded border border-slate-600 bg-slate-700 text-slate-300 text-xs hover:bg-slate-600 transition">Pyramid Dip</button>
            </div>
            <div class="bg-slate-900/50 p-3 rounded border border-slate-700 text-xs">
                <div id="strategy-desc" class="text-blue-200 mb-1 font-bold">Strategy: Wyckoff Sniper</div>
                <div id="strategy-detail" class="text-slate-400">...</div>
            </div>
        </div>
    </section>

    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <div class="card-gradient rounded-xl p-4 border-l-4 border-yellow-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-yellow-500"><i class="fa-brands fa-bitcoin mr-2"></i>BTC Buy Ladder</h3>
                <div class="font-mono font-bold text-white" id="btc-target-budget">฿0</div>
            </div>
            <table class="w-full ladder-table">
                <thead><tr><th>Order</th><th>Condition</th><th>Price (THB)</th><th>Amount (THB)</th></tr></thead>
                <tbody id="btc-ladder-body"></tbody>
            </table>
        </div>
        <div class="card-gradient rounded-xl p-4 border-l-4 border-red-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-red-500"><i class="fa-solid fa-building-columns mr-2"></i>MSTR Buy Ladder</h3>
                <div class="font-mono font-bold text-white" id="mstr-target-budget">฿0</div>
            </div>
            <table class="w-full ladder-table">
                <thead><tr><th>Order</th><th>Price ($)</th><th>Est. Cost (THB)</th><th>Shares</th></tr></thead>
                <tbody id="mstr-ladder-body"></tbody>
            </table>
        </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // --- CONFIG ---
        // ใช้ CORS Proxy เพื่อดึงข้อมูล Yahoo Finance (ฟรี) มาใช้ในการคำนวณ Logic
        const YAHOO_MSTR_API = "https://corsproxy.io/?https://query1.finance.yahoo.com/v8/finance/chart/MSTR?interval=1d&range=3mo";
        const BITKUB_API = "https://api.bitkub.com/api/market/ticker?sym=THB_BTC";
        const BITKUB_CANDLES = "https://api.bitkub.com/api/market/candles?sym=THB_BTC&int=60&lmt=50";

        // State Management
        const state = {
            budget: 567000,
            allocation: 70,
            exchangeRate: 34.50, 
            strategy: 'wyckoff',
            btc: { current: 0, history: [], support: 0, resistance: 0, loaded: false },
            mstr: { current: 160.00, history: [], support: 150.00, resistance: 180.00, loaded: false } 
        };

        const strategies = {
            wyckoff: { name: "Wyckoff Sniper", desc: "40% ที่จุด SC / 60% ที่จุด ST", steps: [{pct:0.4, offset:0, label:"Zone SC"}, {pct:0.6, offset:-0.025, label:"Zone ST"}] },
            dca: { name: "DCA Step", desc: "แบ่ง 3 ไม้เท่ากัน", steps: [{pct:0.33, offset:0, label:"Step 1"}, {pct:0.33, offset:-0.03, label:"Step 2"}, {pct:0.34, offset:-0.06, label:"Step 3"}] },
            pyramid: { name: "Pyramid Dip", desc: "ยิ่งลงยิ่งซื้อเยอะ", steps: [{pct:0.2, offset:0, label:"Test"}, {pct:0.3, offset:-0.04, label:"Dip"}, {pct:0.5, offset:-0.08, label:"Bottom"}] }
        };

        // --- INIT CHARTS & WIDGETS ---
        
        // 1. Bitkub Chart (Chart.js)
        const btcChart = new Chart(document.getElementById('btcChart').getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: '#eab308', borderWidth: 2, tension: 0.3, pointRadius: 0, fill: {target:'origin', above:'#eab30822'} }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}}, scales: {x:{display:false}, y:{display:false}}, animation: false }
        });

        // 2. TradingView Widget for MSTR (The Real Chart)
        function initTradingView() {
            new TradingView.widget({
                "autosize": true,
                "symbol": "NASDAQ:MSTR",
                "interval": "D",
                "timezone": "Asia/Bangkok",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_top_toolbar": true,
                "hide_legend": false,
                "save_image": false,
                "container_id": "tv-chart-container",
                "backgroundColor": "rgba(15, 23, 42, 1)"
            });
        }

        // --- DATA FETCHING ---

        // Fetch USD/THB
        async function fetchFX() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await res.json();
                state.exchangeRate = data.rates.THB;
                document.getElementById('fx-rate').innerText = state.exchangeRate.toFixed(2);
            } catch(e) { console.warn("FX Error"); }
        }

        // Fetch BTC from Bitkub
        async function fetchBTC() {
            try {
                // Price
                const tRes = await fetch(BITKUB_API);
                const tData = await tRes.json();
                if(tData && tData.THB_BTC) {
                    const price = tData.THB_BTC.last;
                    const change = tData.THB_BTC.percentChange;
                    state.btc.current = price;
                    updatePriceUI('btc', price, change, '฿');
                    
                    // Candles (Once or Update)
                    if(state.btc.history.length === 0) {
                        const cRes = await fetch(BITKUB_CANDLES);
                        const cData = await cRes.json();
                        if(cData.result) {
                            state.btc.history = cData.result.map(c=>c[4]);
                            const lows = cData.result.map(c=>c[3]);
                            state.btc.support = Math.min(...lows.slice(-20));
                            state.btc.resistance = Math.max(...cData.result.map(c=>c[2]).slice(-20));
                            updateUIStats('btc');
                        }
                    } else {
                        state.btc.history.push(price);
                        if(state.btc.history.length>50) state.btc.history.shift();
                    }
                    updateChart(btcChart, state.btc.history);
                    runWyckoffLogic('btc', state.btc.history, state.btc.current, state.btc.support);
                }
            } catch(e) { console.error("Bitkub Error", e); }
        }

        // Fetch MSTR Real Data (via Yahoo Proxy for Logic)
        async function fetchMSTR() {
            try {
                // Note: Yahoo API via Proxy is the most stable free way to get raw JSON for logic
                const res = await fetch(YAHOO_MSTR_API);
                const data = await res.json();
                
                if(data.chart && data.chart.result) {
                    const meta = data.chart.result[0].meta;
                    const quotes = data.chart.result[0].indicators.quote[0];
                    
                    const price = meta.regularMarketPrice;
                    const prevClose = meta.chartPreviousClose;
                    const changePct = ((price - prevClose)/prevClose)*100;
                    
                    state.mstr.current = price;
                    state.mstr.loaded = true;

                    // Clean Data for Logic (remove nulls)
                    const closes = quotes.close.filter(c => c !== null);
                    const lows = quotes.low.filter(c => c !== null);
                    const highs = quotes.high.filter(c => c !== null);

                    state.mstr.history = closes.slice(-50); // Keep last 50 for RSI calc
                    state.mstr.support = Math.min(...lows.slice(-20)); // Local support
                    state.mstr.resistance = Math.max(...highs.slice(-20));

                    updatePriceUI('mstr', price, changePct, '$');
                    updateUIStats('mstr');
                    runWyckoffLogic('mstr', state.mstr.history, state.mstr.current, state.mstr.support);
                    updateCalculations();
                }
            } catch(e) { 
                console.error("MSTR Data Error (Proxy)", e);
                document.getElementById('mstr-price').innerText = "Simulating...";
                // Fallback Simulation if Proxy fails
                simulateMSTR();
            }
        }

        // --- HELPERS ---
        function simulateMSTR() {
             // Fallback logic in case Yahoo proxy blocks
             let change = (Math.random()-0.48) * 0.5;
             state.mstr.current += change;
             state.mstr.history.push(state.mstr.current);
             if(state.mstr.history.length>50) state.mstr.history.shift();
             updatePriceUI('mstr', state.mstr.current, (Math.random()-0.5)*2, '$');
             runWyckoffLogic('mstr', state.mstr.history, state.mstr.current, state.mstr.support);
             updateCalculations();
        }

        function updatePriceUI(id, price, changePct, symbol) {
            const pEl = document.getElementById(`${id}-price`);
            pEl.innerText = `${symbol}${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            const cEl = document.getElementById(`${id}-change`);
            cEl.innerText = `${changePct>0?'+':''}${changePct.toFixed(2)}%`;
            cEl.className = changePct>=0?"text-xs font-bold text-green-400":"text-xs font-bold text-red-400";
            if(changePct>=0) pEl.classList.replace('text-red-400','text-green-400'); else pEl.classList.replace('text-green-400','text-red-400');
        }

        function updateUIStats(id) {
            document.getElementById(`${id}-support`).innerText = (id==='btc'?'฿':'$') + state[id].support.toLocaleString(undefined,{maximumFractionDigits:0});
            document.getElementById(`${id}-res`).innerText = (id==='btc'?'฿':'$') + state[id].resistance.toLocaleString(undefined,{maximumFractionDigits:0});
        }

        function updateChart(chart, data) {
            chart.data.datasets[0].data = data;
            chart.options.scales.y.min = Math.min(...data)*0.995;
            chart.options.scales.y.max = Math.max(...data)*1.005;
            chart.update();
        }

        function calculateRSI(prices, period=14) {
            if(prices.length < period+1) return 50;
            let gains=0, losses=0;
            for(let i=prices.length-period; i<prices.length; i++) {
                let diff = prices[i] - prices[i-1];
                if(diff>=0) gains+=diff; else losses-=diff;
            }
            if(losses===0) return 100;
            return 100 - (100/(1+(gains/losses)));
        }

        function runWyckoffLogic(id, history, current, support) {
            const rsi = calculateRSI(history);
            let score = 50;
            const dist = ((current-support)/support)*100;
            
            // Basic Wyckoff Scoring
            if(dist < 2) score += 30; // Near Support (Spring/SC)
            else if(dist < 5) score += 10;
            if(rsi < 35) score += 20; // Oversold
            if(rsi > 70) score -= 20; // Overbought
            
            score = Math.max(0, Math.min(100, score));

            document.getElementById(`${id}-rsi`).innerText = rsi.toFixed(1);
            document.getElementById(`${id}-score-text`).innerText = `${Math.floor(score)}/100`;
            const g = document.getElementById(`${id}-gauge`);
            g.style.width = `${score}%`;
            g.className = `gauge-fill ${score>70?'bg-green-500':(score<40?'bg-red-500':'bg-yellow-500')}`;
            
            let rec = "WAIT";
            if(score>75) rec = "STRONG BUY (Zone SC)";
            else if(score>60) rec = "ACCUMULATE (Zone ST)";
            else if(score<40) rec = "AVOID / SELL";
            document.getElementById(`${id}-recommendation`).innerText = rec;
        }

        function updateCalculations() {
            state.budget = parseFloat(document.getElementById('input-budget').value)||0;
            const btcAlloc = state.budget * (state.allocation/100);
            const mstrAlloc = state.budget - btcAlloc;
            const strat = strategies[state.strategy];

            // Labels
            document.getElementById('btc-target-budget').innerText = "฿"+btcAlloc.toLocaleString({maximumFractionDigits:0});
            document.getElementById('mstr-target-budget').innerText = "฿"+mstrAlloc.toLocaleString({maximumFractionDigits:0});
            document.getElementById('btc-amt-display').innerText = "฿"+btcAlloc.toLocaleString({maximumFractionDigits:0});
            document.getElementById('mstr-amt-display').innerText = "฿"+mstrAlloc.toLocaleString({maximumFractionDigits:0});

            // BTC Ladder
            const btcBody = document.getElementById('btc-ladder-body');
            btcBody.innerHTML = '';
            strat.steps.forEach((s,i) => {
                const px = state.btc.current * (1+s.offset);
                const amt = btcAlloc * s.pct;
                btcBody.innerHTML += `<tr><td class="text-slate-400">#${i+1}</td><td class="text-blue-300 text-xs">${s.label}</td><td class="font-mono">฿${px.toLocaleString(undefined,{maximumFractionDigits:0})}</td><td class="font-mono text-yellow-400">฿${amt.toLocaleString(undefined,{maximumFractionDigits:0})}</td></tr>`;
            });

            // MSTR Ladder
            const mstrBody = document.getElementById('mstr-ladder-body');
            mstrBody.innerHTML = '';
            strat.steps.forEach((s,i) => {
                const pxUSD = state.mstr.current * (1+s.offset);
                const amtTHB = mstrAlloc * s.pct;
                const shares = (amtTHB / state.exchangeRate) / pxUSD;
                mstrBody.innerHTML += `<tr><td class="text-slate-400">#${i+1}</td><td class="font-mono text-xs">$${pxUSD.toFixed(2)}</td><td class="font-mono text-green-400">฿${amtTHB.toLocaleString(undefined,{maximumFractionDigits:0})}</td><td class="font-mono text-slate-400 text-xs">${shares.toFixed(4)}</td></tr>`;
            });
        }

        function updateAllocationDisplay() { state.allocation = parseInt(document.getElementById('allocation-slider').value); document.getElementById('btc-pct-display').innerText = state.allocation+"%"; document.getElementById('mstr-pct-display').innerText = (100-state.allocation)+"%"; updateCalculations(); }
        function setStrategy(s) { state.strategy = s; ['wyckoff','dca','pyramid'].forEach(k=>document.getElementById('btn-'+k).className = k===s?"p-2 rounded border border-blue-500 bg-blue-500/20 text-blue-300 text-xs font-bold transition":"p-2 rounded border border-slate-600 bg-slate-700 text-slate-300 text-xs hover:bg-slate-600 transition opacity-60"); document.getElementById('strategy-desc').innerText="Strategy: "+strategies[s].name; updateCalculations(); }

        // --- STARTUP ---
        initTradingView();
        fetchFX();
        fetchBTC();
        fetchMSTR();
        
        // Loop
        setInterval(fetchBTC, 10000); // 10s
        setInterval(fetchMSTR, 60000); // Yahoo update every 1 min (don't spam proxy)
        updateAllocationDisplay();

    </script>
</body>
</html>
